
<link rel="import" href="../fc-grid/data-manager.html">
<link rel="import" href="../fc-call-center/fc-course-calendar-creation-behavior.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
 <link rel="import" href="../fc-call-center/fc-calendar-behavior-beta-prime.html"> 
<link rel="import" href="../fc-call-center/fc-profile-class.html">
<link rel="import"  href="../fc-call-center/fc-calendar-controller-behavior.html">

<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../fc-app-elements/fc-iss-input/fc-iss-input.html">
<link rel="import" href="../fc-app-elements/fc-panel/fc-panel.html">
<link rel="import" href="../fc-call-center/fc-call-center-form.html">
<dom-module id="fc-drawer-form">
<template id="fc-drawer-form-template">
<style>

:host{
      background: white
      height: 100%;
      width: 100%;
      top: 0;
      right: 0;
      left: 0;
      bottom: 0;
      margin-right: 18px;
      margin-left: -19px;
     position: absolute;
      opacity: 1;
      display: block;
      visibility: visible;
      @apply(--vertical-layout);
      @apply(--layout-flex);
       @apply(--layout-reverse);
    .left.header{
      padding-left: 8px
      right: 14px;
      margin-right: 7px;

      }
    };
   

paper-tab{
  --paper-tab:{
      color: white;
      background: silver;
      font-size: 1.2em;
      @apply(--paper-tab);
    }
}
.header{
position: absolute;
  top: 0px;
  right: 0px;
  left:-8px;
  margin: 0px 0px -58px 0px; 
  font-family: merriweather; 
  padding-bottom: 10px;
  line-height: 1;
  color: #009; 
  font-size: 1.2em;
  font-weight: 300;
  min-height: 222px!important;/*160 at smallest*/ 
  max-height: 23vh; 
  /*min-height: 20vh;*/
  z-index:23999;
  box-shadow:3px 8px 17px 5px #bfbfbf;

}
.title{

  z-index: 220;
  color: black;
  position: absolute;
  left:12px;
  top: 218px;
 font-family:merriweather;
  font-size: 2.1em; 
  color: #009;
  margin-bottom: 3px;
}
.timestamp{
    font-weight: 300;
    color: #009;
    font-family: merriweather;
   font-size: .7em;
    position: absolute;
    color: brown;
    font-family: times;
   top: 210px;
   left: 12px;
   margin-bottom: 4px;
    }
  .subheading{
    font-size: .7em;
    position: absolute;
    color: brown;
    font-family: times;
    top: 192px;
    right: 25px;
    margin-bottom: 4px;

  }

  
     .bar{
      min-width:268px; 
      height: 2px;
      background:silver;
      @apply(--vertical-layout);
      @apply(--layout-flex);
      @apply(--layout-self-stretch);
      position: absolute;
      left: 12px;
      top: 205px;
      right: 22px;
      width: auto;

    }

      neon-animated-pages {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        margin: 22px 12px 12px 0px;
        padding: 6px;
        background: white;
        @apply(--layout-self-stretch);
        min-height: 100%;
        max-height: 80vh;
      }
      

    .container1{
      position: relative;
      min-height: 200vh;
      margin-right: 0px;
      width: 110%
      padding: 0px 3px;
      }

    .last {
      color:brown; 
      font-family: merriweather; 
      float: left; 
      text-align: left;
      padding-bottom: 12px;
    }
    .reverseArrow{

   transform: matrix(-1, 0, 0, 1, 0, -.5);
   display: inline-block;
   filter: flipH;
        -ms-filter: flipH;
    }

    .check{
    font-size:26px;
    color: green;
    position: absolute;
    left: 5px;
    }

   
    .column-container{
      max-height: 200vh;
      width: 100%;
      min-height: 96vh;
      right: -8px;
      padding-right: 8px;
      margin-bottom: -80px;

     /* max-width: 410px;*/
      white-space: wrap;  
      height: calc(96.5vh+120px);
      @apply(--vertical-layout);
      @apply(--layout-center);
      position: static;
      display: block ;
    }
    .footer-container{
    position: absolute;
    overflow:hidden;
    bottom: -4px;
    right: 0px;
    left: -5px;
    padding: 4px;
    border-top: solid 1px silver; 
    margin: 3px auto 4px auto; 
    width: 100%; 
    background: white;
    overflow-x: hidden; 
    min-height: 11vh; 
    max-height: 17vh!important;
    /*max-height: 80px!important;*/
    top: 92%;
    }
    .next{
      color:#005c00;
      font-family: merriweather; 
      float: right; 
      margin-right: 24px;
      white-space: nowrap;
      text-align: right;
      padding-bottom: 12px;

    }
    .one{
    font-family: merriweather; 
    font-weight: 600;
    color: #080808;
    font-size: 14px;
    white-space: nowrap;
    display: inline-block;
    }

@media(max-height: 779px){
    #content{
      @apply(--layout-vertical);
      @apply(--layout-center-justified);
        }
        .header{min-height: 166px; height: 168px!important;};
      .container1{margin-top: 22px!important;}
      }
@media(max-width: 360px){.byebye{display: none;}}

@media(max-height: 320px){
/*  .next{
    display: none;
  }*/
  .middleheader, .bar, .timestamp, .subheading, .last,.next{display: none;}
    /*.bar{display: none;}
  .last{display: none;}*/
  .title{font-size: .6em;top: 80px; left: 12px;}
}

      .intakeForm{
        border: 1px #efefef solid;
        margin: 12px 0px;
      }

    
   
    .show {display:block; z-index: 45; right: 0;}
  </style>
<!--  <app-location route="{{newRoute}}"  use-hash-as-path></app-location> 
  <app-route 
        id="rightInteriorDrawerRouterForms"
        route="{{newRoute}}" 
        pattern="/:formName" 
        data="{{data}}"
        active="{{this.$.dashboardRightDrawer.opened}}">
    </app-route> -->

  <form is="iron-form" id="callIntakeForm" on-tap="_tapHandler" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white;padding: 4px;" hidden$="{{_computeMinWidthHidden(currentInnerWidth)}}"  method="get" action="/">
<div class="column-container">

  
    <div class="header" hidden$="{{hideHeader}}" style$="margin-bottom: 0px; margin-left: 4.5px; z-index: 11; background: white; height:{{headerHeight}}px;">
      <section class="horizontal layout block">
    <span class="title" style$="font-size:{{titleFontSize}}px;top:{{titleTop}}px; padding-left: 4.5px;">{{_computeTitle(pageType, currentInnerWidth)}}</span>
    </section>
             <section class="bar"></section>
        <section class="horizontal layout flex middleheader">
          <span btn="leftClick" class="timestamp">
                [[time]] on [[date]]
          </span>
            <span btn="rightClick" class="subheading"><span class="byebye">Page</span> {{shadowIndex}} of {{pageTotal}}</span>
        </section>
        </div>
 <div id="outerContentContainer" class="layout vertical center-justified" style$="width:calc({{_computeCurrentWidth(currentInnerWidth)}}+125)px; min-height:117vh; overflow-y: scroll;"  on-scroll="handleHeaderOnScroll" hidden$="{{_computeMinWidthHidden(currentInnerWidth)}}">
         <array-selector id="inputsArraySelector" items="{{dataSelected}}" selected="{{_computeSelected(dataSelected)}}"></array-selector> <!--removed margin-top for the new headers-they dont rely on the -150 margins-->
      <neon-animated-pages id="pages" selected="{{selected}}"  class="layout center-justified" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
          <template id="drawerFormRepeater" is="dom-repeat" items="{{dataSelected}}">
          <div id="innerContainer1" class="container1">
              <fc-check-menu id="mycheckMenu" shadow-index="{{shadowIndex}}" style="position: absolute; left: 1px; padding-right: 18px;" form-name="[[pageType]]_[[index]]"forms-display="{{item.form}}" form-name="{{formName}}" caller-role-list="{{callerRoleList}}" value-object="{{valueObject}}" check-event="{{checkEvent}}"></fc-check-menu>
               <fc-call-center-form form-name="[[pageType]][[index]]" form-id="[[item.fcid]]" form-index="[[index]]" value-object="{{valueObject}}" id="generalForm" style="min-height: 650px; padding-bottom: 24px; id="ioForm"  focused-manager="{{focusedManager}}" item-object="{{item}}">
                </fc-call-center-form> 
              </div>
          </template>
 </neon-animated-pages>
  </div>
   <div class="footer-container">
   
              <div class="horizontal flex layout justified">
                  <section class="last" btn="leftClick" style$="font-size:{{_modifySizeRatio(currentInnerWidth)}}px; margin-left:9px;"><section class="last reverseArrow">&#10148; </section> &nbsp; LAST</section>
                  <section class="horizontal layout flex around-justified buttons">
                  <content select='.bottomMenu'></content>
                  </section>
                  <span class="next" style$="font-size:{{_modifySizeRatio(currentInnerWidth)}}px; display: inline-block;" btn="rightClick">NEXT &nbsp; &#10148;</span>
              </div>  
        </div>
      
</div><!-- end container-->
</form>
</template>
<script>
FcDrawerForm=Polymer({
  is:"fc-drawer-form",
     behaviors:[Polymer.NeonAnimatableBehavior,
                Polymer.NeonAnimationBehavior,
                Polymer.NeonAnimationRunnerBehavior,
                FCBehaviors.FocusedDataManagerBehavior
                ],
          
        listeners: {"on-tap":"_tapHandler"},
        observers:['observeValueObjectStar(valueObject.*)'
            ],
properties:{
    time:{
      type:Date,
      value:function(){
          var time=new Date().toLocaleTimeString();
          console.log(time);
          return time;
      },
      notify: true
    },
    hideHeader:{type: Boolean, value: function(){return false;}, notify: true}, 
    pageType:{
      type: String,
      value:function(){return "";},
      notify: true,
    },
    date:{
        type: Date,
        value: function(){
          var date=new Date().toLocaleDateString();
          return date;
            },
        notify: true,
        },
    entryAnimation:{
        type: String,
        value: function(){ return "";},
        notify: true
      },
      shadowIndex:{
          type: Number,
          computed: "_computeShadowIndex(selected)",
          notify: true
      },
      exitAnimation:{
          type: String,
          value: function(){return "";},
          notify: true
      },
      headerHeight:{
        type:Number, 
        value:function(){return 220;},
        observer: "observeHeaderHeight",
        notify: true, 

      },
      arrat:{
        type: Array, 
        value: function(){return [];},
        notify: true,

      },
  valueObject:{
      type: Object,
      value: function(){return {};}, 
      notify: true,
      observer:"observeValueObject",
    },
    dataSelected:{
      type: Array,
      value: function(){return [];},
      notify: true,
    },
    rightRouteData:{
      type: Object,
      value: function(){return {};}, 
      notify: true,
    },
  
    currentWidth:{
      type:String,
      
      notify: true,
    },
    currentInnerWidth:{
      type:Number, 
      notify: true
    },
    titleTop: {
      value: String,
      notify: true
    },
    title:{
      value: String, 
      notify: true,
    },
    scroller:{
      type: Object, 
      notify: true,
    },

    //I use old title as a cheat to resych the pages on a page turn...

    oldTitle:{
      type: String, 
      computed: "_computeTitleNew(title)",
      notify: true,

    },
    selected: {
          type: Number,
          value: function(){return 0;},
          notify: true,
          observer: "observeSelected",
        },
  
    isFormSubmitted:{
        type: Boolean,
        value: false,
        notify: true
      },
       hideInputs:{
        type: Boolean,
        notify: true
      },
      data:{
        type: Object,
        notify: true

      },
      formName:{
        type: String, 
        notify: true
      },
    profiles:{
      type: Array,
      value: null,
      notify: true
    },
    callerRoleList:{
      type: Object,
      value: null,
      notify: true
    },

    pageTotal:{
         type: Number,
            computed: "_computePageTotal(dataSelected)",
            notify: true
        },
        notForm:{
          type: Boolean, 
          notify: true,

        },
    deNowHeight:{
      type: String, 
      notify: true,
      observer: "observeDeNowHeight",
    },
   
  },//end of properties
    
  _computeSelected(dataSelected){
    if(Array.isArray(dataSelected[this.selected])){
      this.set("notForm", true);
    }
    else{this.set("notForm", false);

      }
    console.log(dataSelected, this.selected);
    return dataSelected[this.selected];

  },

  ready(){
    // var maxWidth=window.innerWidth-80;
  this.set("interfaceType", "inputs");
    console.log(this.dataSelected);
    // console.log(maxWidth);
    // this.set("maxWidth",maxWidth);
    // console.log(this.dataSelected);
  },

    attached(){
      this.set("scroller", this.$.outerContentContainer);
    // this.set("interfaceType", "inputs");
    // console.log(this.dataSelected);
console.log(this.formName);
    // var time=setInterval(()=>{console.log(this.style.height); this.set("deNowHeight",this.style.height); this.arrat=[];
    //   this.push("arrat",this.deNowHeight)},500);
  }, 

  get scrolly(){
    return this.$.outerContentContainer;

  },
  get formName(){
    this.$.mycheckMenu.formName;


  },

    _computeTitleNew(title){
      this.set("selected", 0);
      this.set("scroller.scrollTop", 0);
      return title;


    },
  _computeCurrentWidth(ciw){
    var retVal=ciw>=530?530:ciw;
    return retVal;
  },
  observeSelected(nv, ov){
    if(nv){

      console.log(nv,ov, "look here too");}
  },
  computeHiddenForm(obj){
    var retVal=(obj.isForm===true)?false:true;
    this.set("hideInputs", !retVal);
   // console.log(obj.name, obj.isForm, obj.name);
    return retVal;
  },
  computeTwo(one){return !one},

  
  _computeShadowIndex(selected){
    return selected+1;
  },
  _computePageTotal(dataSelected){
    if(dataSelected!=undefined){
           var retVal=dataSelected.length;
         }
    else{var retVal=1;}
    return retVal;

  },

  _computeMinWidthHidden(cwidth){
      var retVal=(cwidth-20<200)?true: false;
      return retVal;
  },
  _modifySizeRatio(ciw){
    var r=(ciw>520)?1.205:(ciw/530)>.80?(ciw/480):(ciw)>289?.73:.6230;
   var retVal=Math.ceil(r*19);
    //console.log(r, retVal);
    return retVal; 
  },


  _computeTitle(interface, currentInnerWidth){
    this.title= this.focusedManager.propertyNameToLabel(interface);
     var pxWidt= this.fitTextInDrawer(this.title);
    this.set("titleFontSize",pxWidt);
    //console.log(this.titleFontSize);
    var top=170+(38-this.titleFontSize)*.955;
    this.set("titleTop", top);
    return this.title;
  },

    fitTextInDrawer(text){
    var size=38;  
    var c=document.createElement("CANVAS");
    var ctx=c.getContext("2d");
        var txt=text;
    while(size>0){
      ctx.font =size+"px"+ " "+"merriweather";
        var width=ctx.measureText(txt).width;
       if(((this.currentInnerWidth)*.60)>=width){this.set("titleSize", width); console.log(width, this.currentInnerWidth);break;}
      size--;
    }
  //  console.log(size);
    return size;
  },

    observeValueObjectStar(val){
    if(val&&val.base){
      //console.log(val.base, val.value);
      this.set("intakeObject", val.base);
      this.intakeProtocol(val.base);

    } 

  }, 
  observeValueObject(newValue, oldValue){
    if(newValue){

      //console.log(newValue, oldValue);
    }

  },
  intakeProtocol(obj){
    if(obj!=undefined){
    if(obj.callerType!=="New Caller" && (obj.callerType!=="other" ||obj.callerType!=="Other")){
      var d=new Date().getTime();
      if(this.profiles==null||((d-this.profiles.timestamp)/60000)>1.5){
    var mymap=this.focusedManager.dashboardMap.get("profiles");
    var profiles= mymap.gridArray[15].map((cell, index)=>{
                return cell.valueObject;//this should be a filter by caller type
        });
    profiles.timestamp=new Date().getTime();
    this.set("profiles", profiles);
    //console.log(profiles, profiles.timestamp); 
      }
    if(obj.callerType!=undefined){if(obj.callerRole==null){   this.async(this.rightClick, 150);}
    if(obj.callerRole!=undefined&&obj.callerRole!="other"){
          if(this.callerRoleList==null){this.async(this.rightClick, 750);}
          var arrayObject={parent1FirstName:[], parent1LastName:[], parent1Telephone: [], parent1Email:[], parent2FirstName:[], parent2LastName:[], parent2Telephone: [], parent2Email:[], studentFirstName:[], studentLastName: [], gradeLevel:[], currentSchool:[], callerFullName:[], studentFullName:[]};
      var callerRoleArray=this.profiles.reduce((pre, prof, i)=>{
              var first= obj.callerRole+"FirstName",last=obj.callerRole+"LastName", email=obj.callerRole+"Email", tele=obj.callerRole+"Telephone";
              if(prof!=undefined){
          var full=prof[first]+" "+prof[last];
          var args=[first, last, email, tele];
          for(var p=0;p<4;p++){
            if(prof&&prof[args[p]])
            arrayObject[args[p]].push(prof[args[p]]);
          }
            return arrayObject;
         } }, arrayObject); 
       //   console.log(arrayObject);
      // filter((val, ind, arr)=>{if(val==undefined){return false;}else{return true;}});
        //console.log(callerRoleArray, "look here");

      this.set("callerRoleList",arrayObject); 
  }
    }
  }
  }

  },


  doStuffOnLoad(e){
         this.async(function(){var ht=window.getComputedStyle(this.$.container1, null).getPropertyValue("height"); var wt=window.getComputedStyle(this.$.container1, null).getPropertyValue("width");//console.log(ht, wt);
          this.style.width="440px"; this.style.height="660px";}, 4);
        //console.log(window.getComputedStyle(this.$.container1, null).getPropertyValue("height"), e);
     },
  


    handleHeaderOnScroll(e){
        
    // var scrollpercent = (this.scrollTop + this.$.innerContainer1.scrollTop) / (this.scrollHeight - this.$.innerContainer1.clientHeight);

    //     console.log(scrollpercent);



    },


 observeDeNowHeight(newVal, oldVal){
  if(newVal){
  // console.log(newVal,this.style.height, oldVal);
}},
    submitHandler(event){
    
          var formResults = this.$.callIntakeForm.serialize();
            var keys=Object.keys(formResults);
            var trueForm=keys;
         var val=this.superValue;
         console.log(this.selectedStoreNumber);
        var type= (this.seachOff===true)?"newClient":"repeatCaller";
        var base=this.focusedManager.databaseIndex[this.selectedStoreNumber];

         var args={
            role:"student",
            type: type,
            grid:this.gridDisplayArray,
            valueObject: this.valueObject, 
            "context": this,
            gridStoreKeys:{"dbName": base.dbName,"storeName":base.storeName, "verion":base.version, "displayIndex":base.displayIndex, "context": this},  
         };
                                
              this.addCallerTypeToGrids(args);
              this.wipeCleanInputs();
     },


    wipeCleanInputs(){
         this.set("superValue",{});
          var pro=new ProfileReformer({});
          this.set("valueObject", pro);
          var count=this.inputsDisplayArray.length;
              for(var i=0;i<count;i++)
              {
               this.inputsDisplayArray[i].forEach((val, j, arr)=>{
                console.log(val, this.inputsDisplayArray[i][j]);
                     this.set(["inputsDisplayArray",i,j,"value"],"");
                     this.set(["inputsDisplayArray",i,j,"valueA"],"");
                     this.set(["inputsDisplayArray",i,j,"valueB"],"");
                    });
               }
        },

   computeDisplay(item, hideInput){
    if(hideInput===true){return "";}
      else {return item;
    }
   },
   
  _tapHandler(e){
    var targ=e.target;
    if(e==null){console.log(null);}
    else if(e.target==null){console.log(null);}
     else if(targ!=null){
            console.log("not null"); 
            if(targ!=undefined&&targ!=null&&targ.attributes&&targ.attributes!=undefined&&targ.attributes!=null)
            {
  
              while(targ.attributes.btn==undefined && targ.nodeName!=="FORM")
              { 
                console.log(targ);
                   targ=targ.parentElement;
            }
            if(targ.attributes.btn){
                  this[targ.attributes.btn.value](e);
             }
          }
        }
  },
  
      observeHeaderHeight(newv, oldv){
        if(newv, oldv){
          console.log(newv, oldv);
        }
      },
       rightClick: function() {
        this.entryAnimation = 'slide-from-left-animation';
        this.exitAnimation = 'slide-right-animation';
        
            this.set("scroller.scrollTop", 0);
       this.selected = (this.selected === (this.dataSelected.length-1))? 0 : (this.selected + 1);
       
      },
      leftClick: function() {
        this.entryAnimation = 'slide-from-right-animation';
        this.exitAnimation = 'slide-left-animation';
        console.log(this.dataSelected, "look here");
            this.set("scroller.scrollTop", 0);
       this.selected = this.selected === 0 ?(this.dataSelected.length-1): (this.selected - 1);
         
      },
      observerForSearch(isPreviousCaller, callerRole){
        if(isPreviousCaller===true){
             if("2".match(callerRole)){this.leftClick();this.leftClick();}
                  else{this.leftClick();}
        }
      },

_computeTimeStampUseful: function(timeStamp, callLogFormOneObject){
    var d = new Date();
    var n = -d.getTime();
    console.log(n);
    return n;

},
layWaste(e){


  this.focusedManager.getReviseResaveAllBasicProfiles(0, "deleteDatabase", "build");

  }
    
});

</script>
</dom-module>



             <!--  <fc-call-center-form-one hidden="{{_computeHidden(item)}}" form-name="[[pageType]][[index]]_1" form-id="" form-index="[[index]]" value-object="{{valueObject}}" id="checkBoxFormOne" style="min-height: 650px; padding-bottom: 24px; overflow-y: scroll;" id="ioForm"  focused-manager="{{focusedManager}}" form-item="[[item]]">
              </fc-call-center-form-one> -->
              <!-- </template> -->



